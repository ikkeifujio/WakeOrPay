# WakeOrPay

起床アラームアプリ - QRコードスキャンによる起床確認システム

## 機能
- **アラーム設定**: 時刻・音声・QRコード設定
- **1分カウントダウン**: fireDate基準の正確なタイマー
- **QRコードスキャン**: 1分以内の有効スキャンで起床成功
- **自動SMS送信**: タイムアウト時の緊急連絡
- **ローカル通知**: アラーム時刻の確実な通知

## 使用技術と選択理由

### iOS / Swift / SwiftUI
- **理由**: ネイティブ性能とUIの美しさ
- **メリット**: バックグラウンド処理、通知、カメラアクセスが確実

### MVVM + AlarmState
- **理由**: 状態管理の一元化でバグ防止
- **メリット**: 成功/失敗の判定を単一箇所で管理

### Vercel Functions + Twilio
- **理由**: サーバーレスでSMS送信を確実に
- **メリット**: アプリクラッシュ時もSMS送信、運用コスト最小

### UserNotifications + AVFoundation
- **理由**: システムレベルの通知と音声制御
- **メリット**: アプリ終了後も確実にアラーム実行

## こだわった実装

### 1. 時間基準カウントダウン
```swift
// fireDateから算出（音声状態に非依存）
let remaining = max(0, 60 - Int(elapsed))
```
- **なぜ**: アプリ再起動時も正確な残り時間を表示
- **効果**: 音声が止まってもカウントダウン継続

### 2. 状態復元の多重保護
```swift
// アプリ起動時の成功ダイアログ誤表示を防止
if isRestoringState || isNotificationLaunch || appLaunchTime < 300 {
    return // ダイアログ表示しない
}
```
- **なぜ**: アプリ起動時の誤った成功表示を完全防止
- **効果**: ユーザー体験の一貫性を保証

### 3. QR厳格検証
```swift
// expectedQR一致 + 1分以内のみ成功
if qrCodeData == expectedQR && elapsed < 60.0 {
    markSuccess()
}
```
- **なぜ**: 不正な起床成功を防止
- **効果**: アラームの信頼性を最大化

### 4. サーバーサイドSMS自動送信
```swift
// アプリクラッシュ時もSMS送信
await ServerWebhookService.notifyTimeout(alarmId, phoneNumber)
```
- **なぜ**: クライアント側の失敗に依存しない
- **効果**: 確実な緊急連絡システム

### 5. 状態の一元化
```swift
// AlarmStateのみが成功/失敗を決定
enum AlarmState {
    case idle, active, success, failure
}
```
- **なぜ**: 複数箇所での状態変更による競合状態を防止
- **効果**: 予測可能で安定した状態遷移

## 動作フロー
1. **設定**: アラーム時刻・QRコード・緊急連絡先設定
2. **通知**: ローカル通知でアラーム時刻を通知
3. **鳴動**: アラーム音開始 + 1分カウントダウン
4. **スキャン**: QRコードスキャン試行
5. **結果**: 成功（ダイアログ） / 失敗（SMS送信）

## セットアップ
1. 緊急連絡先設定
2. QRコード生成・設定
3. 通知権限許可
4. アラーム設定完了